package com.kedacom.ezSafe.qyda.aqyh;

import com.kedacom.ezSafe.common.service.EsCommonService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.swing.text.html.parser.Entity;
import java.text.DateFormat;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.*;

/**
 * Created by fudapeng on 2018/9/13.
 */
@RestController
@RequestMapping("qyda/qyxx")
public class AqyhAPI {

    @Autowired
    EsCommonService esCommonService;

    @Autowired
    AqyhService aqyhService;


    @RequestMapping(value = "aqyh")
    public Map<String,Object> selectAqyhBySeason(Integer year,String qybh){
        Map<String,Object> result= new HashMap<>();
        Map<String,Object> params= new HashMap<>();
        int s = 1;
        for(int i =1;i<=12;i+=3){
            String from = String.format("%d-%02d-01 00:00:00",year,i);
            String to = String.format("%d-%02d-01 00:00:00",year,i+3);
            if(i==10){
                to = String.format("%d-%02d-01 00:00:00",year+1,1);
            }

            System.out.println("from:"+from);
            System.out.println("to:"+to);

            //获取所有任务，
            List<Map<String, Object>> list = aqyhService.selectXCRWByYear(from, to, qybh);
            Set<String> keys =new HashSet<>();

            Iterator<Map<String, Object>> iterator = list.iterator();
            while(iterator.hasNext()){
                Map<String, Object> next = iterator.next();
                keys.add((String)next.get("RWBH"));
            }

            //获取隐患数，和隐患id
            Map<String,Object> aggs =aqyhService.selectDataByYear(keys);
            Set<Map.Entry<String, Object>> entries = aggs.entrySet();
            int j =0;
            for(Map.Entry<String, Object> m: entries){
                String key = m.getKey();
                Object value = m.getValue();
                list.get(0).put("YHSL",value);
                j++;
            }

            result.put("season"+s++,list);
        }

        return result;
    }



}